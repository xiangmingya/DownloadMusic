<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽 - Music Downloader</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css?v=20260225-14">
    <script>
        window.AUTH_API_BASE = window.AUTH_API_BASE || 'https://musicapi.621888.xyz/api/auth';
        window.APP_API_BASE = window.APP_API_BASE || 'https://musicapi.621888.xyz/api/proxy';
    </script>
</head>
<body class="auth-body">
    <div class="login-shell" id="loginShell">
        <div class="login-paper">
            <p class="login-kicker">ようこそ</p>
            <h1 class="login-title">音楽</h1>
            <p class="login-subtitle">Private Access</p>

            <button id="showPasswordLoginBtn" type="button" class="password-login-entry-btn">密码登录</button>

            <form id="passwordLoginForm" class="login-form" style="display:none;">
                <label for="passwordInput">访问密码</label>
                <input id="passwordInput" name="password" type="password" placeholder="输入密码" autocomplete="current-password" required>
                <button type="submit">登录</button>
            </form>

            <div class="login-divider" id="linuxdoDivider">OR</div>
            <a class="linuxdo-btn" id="linuxdoLoginBtn" href="#">
                <span class="linuxdo-logo" aria-hidden="true">
                    <svg viewBox="-158 -158 1890 1890" xmlns="http://www.w3.org/2000/svg" focusable="false">
                        <path fill="#1C1C1E" d="M787,0 a787,787 0 1,0 0,1574 a787,787 0 1,0 0,-1574 Z"/>
                        <path fill="#F0F0F3" d="M783.34,550.29 L413.34,375.67 C388.37,363.88 358.57,374.57 346.78,399.55 C343.63,406.22 342,413.51 342,420.89 L342,842 C342,869.62 364.38,892 392,892 L762,892 C789.62,892 812,869.62 812,842 L812,595.51 C812,576.16 800.84,558.55 783.34,550.29 Z M392,1022 h790 a50,50 0 0,1 50,50 v110 a50,50 0 0,1 -50,50 h-790 a50,50 0 0,1 -50,-50 v-110 a50,50 0 0,1 50,-50 Z"/>
                        <path fill="#FFB003" d="M1013.34,658.68 L1203.34,748.37 C1220.84,756.63 1232,774.24 1232,793.59 L1232,842 C1232,869.62 1209.62,892 1182,892 L992,892 C964.38,892 942,869.62 942,842 L942,703.89 C942,676.28 964.38,653.89 992,653.89 C999.38,653.89 1006.67,655.53 1013.34,658.68 Z"/>
                    </svg>
                </span>
                <span class="linuxdo-btn-label">使用 Linux DO 登录</span>
            </a>
            <p class="login-tip login-tip-subtle" id="linuxdoLoginHint">正在检测 Linux DO 连通性...</p>

            <p class="login-tip" id="loginErrorTip"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <header>
            <div class="header-actions">
                <span class="user-chip" id="userChip">用户</span>
                <a class="logout-link" id="logoutBtn" href="#">退出</a>
            </div>
            <h1>音楽</h1>
            <p class="subtitle">Music Downloader</p>
        </header>

        <main>
            <section class="key-panel key-panel-admin" id="adminKeyPanel" style="display:none;">
                <h2>Key 模式</h2>
                <p>当前为密码登录，默认使用服务器配置的 TuneHub Key。</p>
            </section>

            <section class="key-panel" id="userKeyPanel" style="display:none;">
                <h2>你的 TuneHub API Key</h2>
                <p class="key-panel-desc">Linux DO 登录不会使用服务器 Key。你的 Key 仅保存在当前浏览器，不保存到服务器。</p>
                <p class="privacy-note">隐私说明：我们不会在服务器保存你的 Key；Key 只存在你当前浏览器（localStorage），可随时清空。</p>
                <div class="key-form">
                    <input id="userApiKeyInput" type="password" placeholder="输入 th_ 开头的 Key" autocomplete="off">
                    <button id="saveUserKeyBtn" type="button">保存 Key</button>
                    <button id="clearUserKeyBtn" type="button" class="ghost-btn">清空</button>
                    <a class="apply-key-link app-apply-link" href="https://tunehub.sayqz.com/" target="_blank" rel="noopener noreferrer">去申请 TuneHub Key</a>
                </div>
                <p id="userKeyStatus" class="key-status"></p>
            </section>

            <div class="search-section">
                <div class="search-box">
                    <select id="searchMode">
                        <option value="keyword">关键词</option>
                        <option value="id">ID</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="搜索歌曲或歌单...">
                    <button id="searchBtn">検索</button>
                </div>
                <div class="options-row">
                    <div class="search-type">
                        <button class="type-btn active" data-type="song">单曲</button>
                        <button class="type-btn" data-type="playlist">歌单</button>
                    </div>
                    <div class="platform-selector" id="platformSelector">
                        <label>平台:</label>
                        <select id="platform"></select>
                    </div>
                    <div class="quality-selector">
                        <label>音质:</label>
                        <select id="quality">
                            <option value="128k">128k</option>
                            <option value="320k" selected>320k</option>
                            <option value="flac">FLAC</option>
                            <option value="flac24bit">FLAC 24bit</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="results" class="results"></div>
            <audio id="audio"></audio>
            <div id="toast" class="toast"></div>
        </main>

        <footer>
            <div class="status">
                <span id="serviceStatus">服务状态: <span class="loading">检查中...</span></span>
                <span id="healthStatus">健康状态: <span class="loading">检查中...</span></span>
            </div>
        </footer>

        <div class="floating-dock">
            <button id="playlistFabBtn" class="fab-btn playlist-fab-btn" type="button" title="播放列表">≡</button>
            <button id="playerFabBtn" class="fab-btn player-fab-btn" type="button" title="播放器">◉</button>
        </div>

        <div id="fullPlayerOverlay" class="full-player-overlay" style="display:none;">
            <div class="full-player-backdrop" id="fullPlayerCloseArea"></div>
            <div class="full-player-shell">
                <div class="full-player-top-tools">
                    <button id="fullPlayerBrowserFullscreenBtn" class="full-player-top-btn full-player-fullscreen-btn" type="button" title="进入全屏" aria-label="进入全屏">
                        <span id="fullPlayerBrowserFullscreenIcon" class="top-btn-icon">⤢</span>
                    </button>
                    <button id="fullPlayerCloseBtn" class="full-player-top-btn full-player-close-btn" type="button" title="关闭全屏播放器" aria-label="关闭全屏播放器">
                        <span class="top-btn-icon">×</span>
                    </button>
                </div>
                <div class="full-player-main">
                    <div class="full-player-cover-wrap">
                        <img id="fullPlayerCover" class="full-player-cover" src="" alt="">
                        <h3 id="fullPlayerTitle" class="full-player-title">未播放</h3>
                        <p id="fullPlayerArtist" class="full-player-artist">请选择歌曲</p>
                    </div>
                    <div class="full-player-lyric-wrap">
                        <p class="full-player-kicker">Now Playing</p>
                        <p id="fullPlayerCurrentLyric" class="full-player-current-lyric">点击歌曲开始播放</p>
                        <p id="fullPlayerNextLyric" class="full-player-next-lyric"></p>
                    </div>
                </div>
                <div class="full-player-progress-row">
                    <span id="fullPlayerTimeCurrent">0:00</span>
                    <div class="full-player-progress-bar" id="fullPlayerProgressBar">
                        <div id="fullPlayerProgressFill" class="full-player-progress-fill"></div>
                    </div>
                    <span id="fullPlayerTimeTotal">0:00</span>
                </div>
                <div class="full-player-controls">
                    <button id="fullPlayerModeBtn" type="button" aria-label="播放模式：列表" title="播放模式：列表">
                        <span id="fullPlayerModeLabel" class="control-icon control-text">列表</span>
                    </button>
                    <button id="fullPlayerPrevBtn" type="button" aria-label="上一首">
                        <span class="control-icon">⏮</span>
                    </button>
                    <button id="fullPlayerToggleBtn" type="button" aria-label="播放">
                        <span id="fullPlayerToggleIcon" class="control-icon">▶</span>
                    </button>
                    <button id="fullPlayerNextBtn" type="button" aria-label="下一首">
                        <span class="control-icon">⏭</span>
                    </button>
                    <button id="fullPlayerQueueBtn" type="button" aria-label="打开播放列表" title="打开播放列表">
                        <span class="control-icon">≡</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="playlistSheet" class="playlist-sheet" style="display:none;">
            <div class="playlist-sheet-backdrop" id="playlistSheetBackdrop"></div>
            <div class="playlist-sheet-panel">
                <div class="playlist-sheet-header">
                    <h3>播放列表</h3>
                    <div class="playlist-sheet-actions">
                        <button id="playlistSearchBtn" type="button" class="ghost-btn">搜索</button>
                        <button id="playlistClearBtn" type="button" class="ghost-btn">清空</button>
                        <button id="playlistCloseBtn" type="button" class="ghost-btn">关闭</button>
                    </div>
                </div>
                <div id="playlistSheetList" class="playlist-sheet-list"></div>
            </div>
        </div>
    </div>

    <script>
    (function () {
        const AUTH_BASE = String(window.AUTH_API_BASE || '/api/auth').replace(/\/$/, '');
        const APP_BASE = String(window.APP_API_BASE || '/api/proxy').replace(/\/$/, '');
        const APP_ASSET_VERSION = '20260225-14';
        window.AUTH_API_BASE = AUTH_BASE;
        window.APP_API_BASE = APP_BASE;

        let appScriptLoaded = false;
        let appScriptLoading = false;
        let appMounted = false;
        let loginCheckPromise = null;

        function setLoginTip(message, isError) {
            const el = document.getElementById('loginErrorTip');
            if (!el) return;
            el.textContent = message || '';
            if (isError) {
                el.classList.add('warn');
            } else {
                el.classList.remove('warn');
            }
        }

        async function authFetch(path, init = {}) {
            const response = await fetch(`${AUTH_BASE}${path}`, {
                credentials: 'include',
                ...init
            });
            const text = await response.text();
            let data = {};
            try {
                data = JSON.parse(text);
            } catch {
                data = { message: text };
            }
            return { response, data };
        }

        async function checkLinuxdoStatus() {
            const btn = document.getElementById('linuxdoLoginBtn');
            const hint = document.getElementById('linuxdoLoginHint');
            const divider = document.getElementById('linuxdoDivider');
            if (!btn || !hint) return;

            const redirect = encodeURIComponent(window.location.origin + window.location.pathname);
            btn.href = `${AUTH_BASE}/login/linuxdo?redirect=${redirect}`;

            try {
                const { response, data } = await authFetch('/linuxdo-status');
                const status = data && data.data ? data.data : {};
                const reachable = Boolean(status.reachable);
                const configured = Boolean(status.configured);
                if (response.ok && configured && reachable) {
                    hint.style.display = 'none';
                    return;
                }
                btn.style.display = 'none';
                if (divider) divider.style.display = 'none';
                hint.classList.add('warn');
                hint.textContent = configured
                    ? '当前服务器网络无法连接 Linux DO，已隐藏该登录方式。'
                    : 'Linux DO 登录未配置，已隐藏该登录方式。';
            } catch {
                btn.style.display = 'none';
                if (divider) divider.style.display = 'none';
                hint.classList.add('warn');
                hint.textContent = 'Linux DO 状态检测失败，已隐藏该登录方式。';
            }
        }

        function mountApp(meData) {
            if (appMounted) return;
            appMounted = true;

            const authType = String(meData.auth_type || '');
            const user = meData.user || {};

            window.APP_CONTEXT = {
                authType: authType,
                user: {
                    id: String(user.id || ''),
                    name: String(user.name || '用户'),
                    linuxdo_id: String(user.linuxdo_id || ''),
                    avatar: String(user.avatar || '')
                }
            };

            document.body.classList.remove('auth-body');
            document.body.classList.add('app-body');
            document.getElementById('loginShell').style.display = 'none';
            document.getElementById('appContainer').style.display = '';
            document.getElementById('userChip').textContent =
                `${window.APP_CONTEXT.user.name} · ${authType === 'password' ? '密码登录' : 'Linux DO'}`;

            document.getElementById('adminKeyPanel').style.display = authType === 'password' ? '' : 'none';
            document.getElementById('userKeyPanel').style.display = authType === 'linuxdo' ? '' : 'none';

            if (!appScriptLoaded && !appScriptLoading) {
                appScriptLoading = true;
                const existing = document.getElementById('appRuntimeScript');
                if (existing) {
                    appScriptLoading = !appScriptLoaded;
                    return;
                }
                const s = document.createElement('script');
                s.id = 'appRuntimeScript';
                s.src = `script.js?v=${APP_ASSET_VERSION}`;
                s.onload = function () {
                    appScriptLoaded = true;
                    appScriptLoading = false;
                };
                s.onerror = function () {
                    appScriptLoading = false;
                    appMounted = false;
                    setLoginTip('应用脚本加载失败，请刷新重试。', true);
                };
                document.body.appendChild(s);
            }
        }

        async function checkLoginAndStart() {
            if (loginCheckPromise) return loginCheckPromise;
            loginCheckPromise = (async function () {
                const { response, data } = await authFetch('/me');
                if (response.ok && Number(data.code) === 0 && data.data) {
                    setLoginTip('', false);
                    mountApp(data.data);
                    return true;
                }
                return false;
            })();
            try {
                return await loginCheckPromise;
            } finally {
                loginCheckPromise = null;
            }
        }

        async function doPasswordLogin(password) {
            const { response, data } = await authFetch('/login/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });

            if (!response.ok || Number(data.code) !== 0) {
                throw new Error(data.message || '登录失败');
            }
        }

        async function doLogout() {
            await authFetch('/logout', {
                method: 'POST'
            });
            window.location.href = window.location.origin + window.location.pathname;
        }

        document.getElementById('showPasswordLoginBtn').addEventListener('click', function () {
            document.getElementById('showPasswordLoginBtn').style.display = 'none';
            const form = document.getElementById('passwordLoginForm');
            form.style.display = 'flex';
            document.getElementById('passwordInput').focus();
        });

        document.getElementById('passwordLoginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const input = document.getElementById('passwordInput');
            const password = String(input.value || '');
            try {
                await doPasswordLogin(password);
                await checkLoginAndStart();
            } catch (err) {
                setLoginTip(err.message || '密码错误，请重试。', true);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async function (e) {
            e.preventDefault();
            await doLogout();
        });

        const loginState = new URLSearchParams(window.location.search).get('login');
        if (loginState && loginState.startsWith('failed')) {
            setLoginTip('Linux DO 登录失败，请稍后重试。', true);
            history.replaceState(null, '', window.location.origin + window.location.pathname);
        }

        (async function init() {
            await checkLinuxdoStatus();
            await checkLoginAndStart();
        })();
    })();
    </script>
</body>
</html>
